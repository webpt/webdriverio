"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const polka_1 = __importDefault(require("polka"));
const parse_1 = require("@polka/parse");
const store = {};
const validateBody = (req, res, next) => {
    if (!req.path.endsWith('/get') && !req.path.endsWith('/set')) {
        return next();
    }
    if (req.method === 'POST' && typeof req.body.key !== 'string') {
        res.end(JSON.stringify({ error: 'Invalid payload, key is required.' }));
    }
    next();
};
const app = polka_1.default()
    .use(parse_1.json(), validateBody)
    .post('/get', (req, res) => {
    res.end(JSON.stringify({ value: store[req.body.key] }));
})
    .post('/set', (req, res) => {
    store[req.body.key] = req.body.value;
    return res.end();
});
const startServer = () => new Promise((resolve, reject) => {
    app.listen(0, (err) => {
        if (err) {
            return reject(err);
        }
        resolve({
            port: app.server.address().port
        });
    });
});
const stopServer = () => new Promise((resolve) => {
    if (app.server.close) {
        return app.server.close(() => resolve());
    }
    resolve();
});
exports.default = { startServer, stopServer, __store: store };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLGtEQUF5QjtBQUN6Qix3Q0FBbUM7QUFJbkMsTUFBTSxLQUFLLEdBQWUsRUFBRSxDQUFBO0FBRTVCLE1BQU0sWUFBWSxHQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTtJQUM1QyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUMxRCxPQUFPLElBQUksRUFBRSxDQUFBO0tBQ2hCO0lBQ0QsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLE1BQU0sSUFBSSxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLFFBQVEsRUFBRTtRQUMzRCxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsbUNBQW1DLEVBQUUsQ0FBQyxDQUFDLENBQUE7S0FDMUU7SUFDRCxJQUFJLEVBQUUsQ0FBQTtBQUNWLENBQUMsQ0FBQTtBQUVELE1BQU0sR0FBRyxHQUFHLGVBQUssRUFBRTtLQUtkLEdBQUcsQ0FBQyxZQUFJLEVBQUUsRUFBRSxZQUFZLENBQUM7S0FHekIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUN2QixHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7QUFDckUsQ0FBQyxDQUFDO0tBQ0QsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUN2QixLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFhLENBQUMsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQXVDLENBQUE7SUFDaEYsT0FBTyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUE7QUFDcEIsQ0FBQyxDQUFDLENBQUE7QUFFTixNQUFNLFdBQVcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtJQU90RCxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQVUsRUFBRSxFQUFFO1FBRXpCLElBQUksR0FBRyxFQUFFO1lBQ0wsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7U0FDckI7UUFDRCxPQUFPLENBQUM7WUFDSixJQUFJLEVBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQWtCLENBQUMsSUFBSTtTQUNuRCxDQUFDLENBQUE7SUFDTixDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQyxDQUFBO0FBRUYsTUFBTSxVQUFVLEdBQUcsR0FBRyxFQUFFLENBQUMsSUFBSSxPQUFPLENBQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRTtJQUNuRCxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFO1FBQ2xCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQTtLQUMzQztJQUNELE9BQU8sRUFBRSxDQUFBO0FBQ2IsQ0FBQyxDQUFDLENBQUE7QUFFRixrQkFBZSxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBdUIsQ0FBQSJ9